<!DOCTYPE html>
<html lang="es-AR">
<head>
<title>Aero Gestión: Aeroclub Huinca Renancó</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="lib/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="lib/w2ui.min.js"></script>
<script type="text/javascript" src="lib/es-ar.js"></script>
<script type="text/javascript" src="lib/jsonbin.js"></script>

<script type="text/javascript" src="grids.js"></script>

<link rel="stylesheet" type="text/css" href="css/w2ui.min.css"/>
</head>

<body>

<div id="mainLayout" style="position: relative; width: 100%; height: 100vh"></div>

<script type="text/javascript">

// localStorage.clear();

// jsonbin.io ids
var binId = localStorage.getItem('binId'),
    collectionId = '5d8635604e32f5653c4bba48', // aerodata
    jsonbinApiKey = '$2a$10$5pdeyOfQ.lLhNXvc.eOn1eeyc2y2QDmBH./T3rWPath03g9YEO.Vq';

// data records
var grids = ['aeronaves', 'socios', 'tarifas', 'vuelos', 'combustible',
             'conceptos', 'cuentas', 'movs'],
    data = {};

// Read JSON data from jsonbin.io
function loadBin() {
    console.log('Loading bin ' + binId + ' ...');
    getBin(binId, jsonbinApiKey, (json) => {
        console.log('jsonbin data loaded...');
        data = JSON.parse(json);
        updateLists();
        createGrids();
    });
}

var selectList = {
    tiposSocio: [
                    { id: 1, text: "Piloto" },
                    { id: 2, text: "Alumno piloto" },
                    { id: 3, text: "Socio no piloto" },
                    { id: 4, text: "Cliente/Proveedor" },
                    { id: 5, text: "Piloto externo"},
                    { id: 1000, text: "Cuenta"},
                    { id: 2000, text: "Otro"}
                ],
    depComb:   [
                    { id: 1, text: "Cisterna" },
                    { id: 2, text: "LV-YRE" },
                    { id: 3, text: "LV-MIR" },
                    { id: 4, text: "LV-GZG"},
                    { id: 5, text: "Compra"},
                    { id: 1000, text: "Otro"}
                ],
    tiposVuelo: [
                    { id: 1, text: "Piloto" },
                    { id: 2, text: "Con instructor" },
                    { id: 3, text: "Alumno piloto" },
                    { id: 4, text: "Adaptación" },
                    { id: 5, text: "Re-adaptación" },
                    { id: 6, text: "Bautismo" },
                    { id: 7, text: "Terceros" },
                    { id: 8, text: "Entrenamiento" },
                    { id: 9, text: "Taller" },
                    { id: 1000, text: "Otro" }
                ]
};

function updateLists() {

    // Generate a list (for select) from data stores
    function updateList(store, fieldName) {
        selectList[store] = [];
        for (let rec of data[store]) {
            selectList[store].push({ id: rec.recid, text: rec[fieldName]});
        }
    }

    updateList('aeronaves', 'matricula');
    updateList('socios', 'nombre');
    updateList('conceptos', 'descripcion');
    updateList('cuentas', 'descripcion');
}

//=============================================================================
// On load, create main layout
//=============================================================================
$(function () {
    var pstyle = 'background-color: #F5F6F7; border: 1px solid #dfdfdf; padding: 5px;',
        initialImg = '<img src="img/aero.jpg"/>';

    w2utils.locale(es);

    //=========================================================================
    // Main layout
    //=========================================================================
    $('#mainLayout').w2layout({
        name: 'layout',
        panels: [
            { type: 'top',  size: 50, resizable: true, style: pstyle,
              content: '<h2>Aeroclub Huinca Renancó</h2>' },
            { type: 'left', size: '15%', resizable: true, style: pstyle },
            { type: 'main', size: '100%', style: pstyle, content: initialImg },
            { type: 'bottom', size: 50, resizable: true, style: pstyle, content: '' }
        ]
    });

    //=========================================================================
    // Sidebar: opciones
    //=========================================================================
    w2ui.layout.content('left', $().w2sidebar({
        name: 'menu',
        nodes: [
            { id: 'aeronaves', text: 'Aeronaves', img: 'icon-folder', onClick: showGrid },
            { id: 'socios', text: 'Socios/Clientes/Cuentas/Prov', img: 'icon-folder',
              onClick: showGrid },
            { id: 'vuelos', text: 'Vuelos', img: 'icon-folder', onClick: showGrid },
            { id: 'tarifas', text: 'Tarifas', img: 'icon-folder', onClick: showGrid },
            { id: 'combustible', text: 'Combustible', img: 'icon-folder', onClick: showGrid },
            { id: 'conceptos', text: 'Conceptos', img: 'icon-folder', onClick: showGrid },
            { id: 'cuentas', text: 'Cuentas', img: 'icon-folder', onClick: showGrid },
            { id: 'movs', text: 'Movimientos', img: 'icon-folder', onClick: showGrid },
            { id: 'ctacte', text: 'Ctas. Ctes.', img: 'icon-folder', onClick: gridSaldos },
            { id: 'save', text: 'Guardar datos', img: 'icon-folder', onClick: saveData }
        ],
    }));

    if (binId) {
        loadBin();
    } else {
        w2prompt({label: 'Id:', value: ''})
        .ok(function(value) {
            console.log(value);
            binId = value;
            localStorage.setItem('binId', binId);
            loadBin();
        });
    }
});

//=============================================================================
// Utilities
//=============================================================================
function showGrid(event) {
    w2ui['layout'].content('main', w2ui[event.target]);
    w2ui[event.target].refresh();
}

function saveData() {
    console.log('Saving data...');

    // update data records
    data = {};
    console.log(data);
    updateBin(binId, jsonbinApiKey, JSON.stringify(data), (response) => {
        alert(response);
    });
}

// Update database on grid edition
function updateData(event) {
    w2ui[grid].mergeChanges();
    updateLists();
}

function existeCuenta(nro) {
    for (c of w2ui['cuentas'].records) {
        if (c.recid == nro)
            return true;
    }
    return false;
}

function updateCuentas(event) {
    for (let s of selectList['socios']) {
        if (!existeCuenta(s.id)) {
            // add to cuentas w2ui table
            let cuenta = {recid: s.id, descripcion: s.text};
            data['cuentas'].push(cuenta);
            w2ui['cuentas'].add(cuenta);
        }
    }
}

function today() {
    return (new Date()).toLocaleString();
}

// add record with default values to grid and database
function addDefaultRecord(event) {
  var grid = event.target,
      records = w2ui[grid].records,
      maxrecid = 0,
      record = null;

  // calculate next recid
  for (var i=0; i<records.length; i++) {
    maxrecid = Math.max(records[i].recid, maxrecid);
  }
  maxrecid += 1;

  switch (grid) {
      case 'aeronaves':
          record = { recid: maxrecid, marca: 'Piper', matricula: 'LV-', obs: ''};
          break;
      case 'socios':
          record = {
              recid: maxrecid, nro: 1000, nombre: '', dni: '', cuit: '', licencia: '', email: '', desde: '', tipo: selectList['tiposSocio'][0]
          };
          break;
      case 'vuelos':
          record = {
              recid: maxrecid, aeronave: selectList['aeronaves'][0],
              piloto: selectList['socios'][0], tipovuelo: selectList['tiposVuelo'][0],
              desde: 'Huinca Renancó', hasta: 'local', aterrizajes: 1,
              odomant: 0, odomact: 0, duracion: 0.0, salida: today(), llegada: today()
          };
          break;
      case 'combustible':
          record = {
              recid: maxrecid, fecha: today(), origen: selectList['depComb'][0],
              destino: selectList['depComb'][0], contadorinicial: 0.0, contadorfinal: 0.0,
              litros: 0.0, remanente: 0.0, obs: ''
          };
          break;
      case 'tarifas':
          record = {
              recid: maxrecid, aeronave: selectList['aeronaves'][0], pilotos: 0.0, alumnos: 0.0,
              pilotosext: 0.0, particular: 0.0, instructor: 0.0, vigente: today()
          };
          break;
      case 'conceptos':
          record = {
              recid: maxrecid, descripcion: 'Nuevo concepto...'
          };
          break;
      case 'cuentas':
          record = {
              recid: maxrecid, descripcion: 'Nueva cuenta...'
          };
          break;
      case 'movs':
          record = {
              recid: maxrecid, socio: selectList['socios'][0], fecha: today(),
              concepto: selectList['conceptos'], debe: 0.0, haber: 0.0, ref: '', obs: ''
          };
          break;
  }

  w2ui[grid].add(record);
}

// calcula la duración del vuelo y hora de llegada dada la diferencia del odómetro
function updateVuelo(event) {
    event.onComplete = function() {
        switch (event.column) {
            case 0: { // cuando se seleccione el avión
                let aeronave = event.value_new.text,
                    odometroAnterior = 0;
                // buscamos valor final del odómetro de esta aeronave
                console.log('aeronave: ' + aeronave);
                for (let vuelo of w2ui['vuelos'].records) {
                    console.log('vuelo: ' + JSON.stringify(vuelo.aeronave));
                    if (vuelo.aeronave == aeronave && odometroAnterior < vuelo.odomact) {
                        console.log('Odometro anterior found!');
                        odometroAnterior = vuelo.odomact;
                    }
                }
                console.log('Odometro anterior: ' + odometroAnterior);
                w2ui['vuelos'].set(event.recid, {odomant: odometroAnterior});
                break;
            }
            case 7: { // cuando se cambia el odómetro de llegada
                let odomant  = w2ui['vuelos'].getCellValue(event.index, 6),
                    odomact  = w2ui['vuelos'].getCellValue(event.index, 7),
                    odomdiff = odomact - odomant,
                    minutes = odomdiff * 0.6,
                    hourPercent = (minutes / 60).toFixed(1);
                // console.log('odomdiff: ' + odomdiff);
                // console.log('minutes: ' + minutes);
                w2ui['vuelos'].set(event.recid, {duracion: hourPercent});
                break;
            }
        }
    };
}

// Calcula los litros remanentes en la cisterna
function calcLitrosCisterna(event) {
        // to do...
}

// Debitar los vuelos seleccionados
function debitarVuelos() {
}

</script>

</body>
</html>
